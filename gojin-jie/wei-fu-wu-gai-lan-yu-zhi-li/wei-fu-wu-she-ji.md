# 微服务设计

#### API Gateway

SOA服务化的架构演进过程中 , 按照垂直功能进行了拆分 , 对外暴露了一批微服务 , 但是因为缺乏统一的出口面临了不少困难 :

* 客户端到微服务直接通信 , 强耦合 .
* 需要多次请求 , 客户端聚合数据 , 工作量巨大 , 延迟高 .
* 协议不利于统一 , 各个部门间有差异 , 需要端来兼容 .
* 面向“端”的API适配 , 耦合到了内部服务 .
* 多终端兼容逻辑复杂 , 每个服务都需要处理 .
* 统一逻辑无法收敛 , 比如安全认证、限流 .

![](/assets/wangguan1.png)

新增了一个 app-interface 用于统一的协议出口 , 在服务内进行大量的 dataset join , 按照业务场景来设计粗粒度的 API , 给后续服务的演进带来的很多优势 :

* 轻量交互 : 协议精简、聚合 . 
* 差异服务 : 数据裁剪以及聚合、针对终端定制化API . 
* 动态升级 : 原有系统兼容升级 , 更新服务而非协议 . 
* 沟通效率提升 : 协作模式演进为移动业务+网关小组 . 

BFF 可以认为是一种适配服务 , 将后端的微服务进行适配\(主要包括聚合裁剪和格式适配等逻辑\) , 向无线端设备暴露友好和统一的 API , 方便无线设备接入访问后端服务 .

![](/assets/wangguan2.png)

最致命的一个问题是整个 app-interface 属于 single point of failure , 严重代码缺陷或者流量洪峰可能引发集群宕机 . 

* 单个模块也会导致后续业务集成复杂度高 , 根据康威法则 , 单块的无线BFF和多团队之间就出现不匹配问题 , 团队之间沟通协调成本高 , 交付效率低下 . 
* 很多跨横切面逻辑 , 比如安全认证 , 日志监控 , 限流熔断等 . 随着时间的推移 , 代码变得越来越复杂 , 技术债越堆越多 . 

![](/assets/wangguan3.png)



